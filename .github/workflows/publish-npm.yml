name: Publish to NPM
on:
  push:
    tags: ['v*']

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with: { go-version: '1.24' }
      - uses: actions/setup-node@v4
        with: 
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm to latest
        run: npm install -g npm@latest
        
      - name: Build and Publish
        env:
          # REMOVED: NODE_AUTH_TOKEN (Let OIDC handle it)
          VERSION: ${{ github.ref_name }}
        run: |
          CLEAN_VER=$(echo $VERSION | sed 's/v//')
          
          PLATFORMS=(
            "linux/amd64/linux-x64"
            "linux/arm64/linux-arm64"
            "darwin/amd64/darwin-x64"
            "darwin/arm64/darwin-arm64"
            "windows/amd64/win32-x64"
          )

          for item in "${PLATFORMS[@]}"; do
            IFS="/" read -r OS ARCH FOLDER <<< "$item"
            EXT=""
            if [ "$OS" == "windows" ]; then EXT=".exe"; fi
            
            TARGET_BIN="npm/$FOLDER/bin/sql-migrate$EXT"
            mkdir -p "npm/$FOLDER/bin"

            echo "Building for $FOLDER..."
            CGO_ENABLED=0 GOOS=$OS GOARCH=$ARCH go build -ldflags="-s -w" -o "$TARGET_BIN" ./sql-migrate

            if [ "$OS" != "windows" ]; then
              chmod +x "$TARGET_BIN"
              echo "Set +x permission for $TARGET_BIN"
            fi
            
            
            cd npm/$FOLDER
            
            npm version $CLEAN_VER --no-git-tag-version --allow-same-version
            npm publish --access public --provenance
            cd ../..
          done

          node npm/test/verify-binary.js

          cd npm/main
          
          sed -i "s/\"[0-9]\+\.[0-9]\+\.[0-9]\+\"/\"$CLEAN_VER\"/g" package.json
          
          npm version $CLEAN_VER --no-git-tag-version --allow-same-version
          npm publish --access public --provenance