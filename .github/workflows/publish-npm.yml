name: Publish to NPM
on:
  push:
    tags: ['v*']

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with: { go-version: '1.24' }
      - uses: actions/setup-node@v4
        with: 
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Build and Publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          VERSION: ${{ github.ref_name }}
        run: |
          CLEAN_VER=$(echo $VERSION | sed 's/v//')
          
          PLATFORMS=(
            "linux/amd64/linux-x64"
            "linux/arm64/linux-arm64"
            "darwin/amd64/darwin-x64"
            "darwin/arm64/darwin-arm64"
            "windows/amd64/win32-x64"
          )

          for item in "${PLATFORMS[@]}"; do
            IFS="/" read -r OS ARCH FOLDER <<< "$item"
            EXT=""
            if [ "$OS" == "windows" ]; then EXT=".exe"; fi
            
            # DEFINE THE PATH HERE SO CHMOD CAN FIND IT
            TARGET_BIN="npm/$FOLDER/bin/sql-migrate$EXT"
            
            # Ensure the bin directory exists
            mkdir -p "npm/$FOLDER/bin"

            # 1. Compile Go Binary
            echo "Building for $FOLDER..."
            CGO_ENABLED=0 GOOS=$OS GOARCH=$ARCH go build -ldflags="-s -w" -o "$TARGET_BIN" ./sql-migrate

            # 2. Set Permissions (using the variable we just defined)
            if [ "$OS" != "windows" ]; then
              chmod +x "$TARGET_BIN"
              echo "Set +x permission for $TARGET_BIN"
            fi
            
            # 3. Publish Platform Package
            cd npm/$FOLDER
            # Copy License (Important for MIT compliance!)
            npm version $CLEAN_VER --no-git-tag-version
            npm publish --access public
            cd ../..
          done

          # 4. Final step: Verify with your script before publishing main
          node npm/test/verify-binary.js

          # 5. Publish Main Wrapper
          cd npm/main
          
          npm version $CLEAN_VER --no-git-tag-version
          npm publish --access public